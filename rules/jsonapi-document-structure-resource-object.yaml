# Document Structure - Resource Object
# https://jsonapi.org/format/#document-resource-objects

# all rules in this file MUST have corresponding tests

rules:
  resource-object-properties:
    description: "Must follow resource object properties"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    #Grab properties only of data and included (error objects and others from top level are not resource objects)
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[data, included]..properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - type
          - id
          - attributes
          - relationships
          - links
          - meta

  resource-object-properties-included:
    description: "A resource object must contain the top-level members type and id"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    #TODO: Exclude the case of post and requestBody in this one
    #TODO: deal with data being either an array or a singular object, which would change where to retrieve required from
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[data, included]..required[*]
    then:
      field: 'type'
      function: truthy
      field: 'id'
      function: truthy
  
  resource-object-id-exception:
    description: "The id member is not required when the resource object originates at the client and represents a new resource to be created on the server"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..[?(@property === 'post')][?(@property === 'requestBody')]..schema.properties[?(@property === 'data')].required
    then:
      field: 'type'
      function: truthy
