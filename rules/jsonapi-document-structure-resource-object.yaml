# Document Structure - Resource Object
# https://jsonapi.org/format/#document-resource-objects

# all rules in this file MUST have corresponding tests

rules:
  resource-object-properties-object:
    description: "Must follow resource object properties"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    #Grab properties only of data and included (error objects and others from top level are not resource objects)
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[data, included][?(@property === 'type' && @ === 'object')]^.properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - type
          - id
          - attributes
          - relationships
          - links
          - meta

  resource-object-properties-array:
    description: "Must follow resource object properties"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    #Grab properties only of data and included (error objects and others from top level are not resource objects)
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[data, included][?(@property === 'type' && @ === 'array')]^..allOf.*.properties
    then:
      field: "@key"
      function: enumeration
      functionOptions:
        values:
          - type
          - id
          - attributes
          - relationships
          - links
          - meta
  
  resource-object-properties-included-object:
    description: "A resource object must contain the top-level members type and id"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    #TODO: Exclude the case of post and requestBody in this one
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[data, included][?(@property === 'type' && @ === 'object')]^.required[*]
    then:
      field: 'type'
      function: truthy
      field: 'id'
      function: truthy
  
  resource-object-properties-included-array:
    description: "A resource object must contain the top-level members type and id"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..content[?(@property === 'application/vnd.api+json')].schema.properties[data, included][?(@property === 'type' && @ === 'array')]^..allOf.*.required[*]
    then:
      field: 'type'
      function: truthy
      field: 'id'
      function: truthy
  

  resource-object-id-exception-object:
    description: "The id member is not required when the resource object originates at the client and represents a new resource to be created on the server"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..[?(@property === 'post')][?(@property === 'requestBody')]..schema.properties[data][?(@property === 'type' && @ === 'object')]^.required[*]
    then:
      field: 'type'
      function: truthy

  resource-object-id-exception-array:
    description: "The id member is not required when the resource object originates at the client and represents a new resource to be created on the server"
    documentationUrl: https://jsonapi.org/format/#document-resource-objects
    message: "{{path}} - {{description}}"
    severity: error
    given: $.paths..[?(@property === 'post')][?(@property === 'requestBody')]..schema.properties[data][?(@property === 'type' && @ === 'array')]^..allOf.*.required[*]
    then:
      field: 'type'
      function: truthy
